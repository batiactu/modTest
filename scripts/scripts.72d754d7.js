function ApiException(a){this.value=a,this.message="Erreur lors de la demande de données : ",this.toString=function(){return this.message+this.value}}function round2nbv(a){return Math.round(100*a)/100}function Navigation(a){this.el=jQuery(a),jQuery("span.prj-name").html(Projet.nomPrj),jQuery("button.parametres").click(function(){this.PageParametre()}.bind(this)),jQuery("button.supp-base").click(function(){webSqlApi.deleteDatabase()}.bind(this)),jQuery("button.retourOuvrage").click(function(){this.PageOuvrage()}.bind(this)),jQuery("button.modif-prix").click(function(){this.PageFourniture()}.bind(this))}function Parametres(a){this.el=jQuery(a),jQuery("div#headingCP").on("dblclick",function(){this.params.debug=!this.params.debug,GenInfo.debug("Passage en mode debug : ",this.params.debug),this.params.debug?jQuery(".debug").show():jQuery(".debug").hide()}.bind(this)),jQuery("button.paramRetourOuvrage").click(function(){this.restaureParams(),navigation.PageOuvrage()}.bind(this)),jQuery("button.ValidParam").click(function(){var a=this.setParametresFromHtml();1==a&&navigation.PageOuvrage()}.bind(this))}function BlockOuvrage(a){this.el=jQuery(a);var b=this;this.init(),this.getFamille(),jQuery("#baFamille").on("change",function(){var a=jQuery(this).val();return b.changeSelect(this),jQuery(this).parent().parent().nextAll().remove(),""===a?!1:void b.getFamille("1",a)}),jQuery("#choix-serie").on("change",function(a){parametres.params.choixSerie=jQuery(a.currentTarget).val(),parametres.params.choixSerieName=jQuery(a.currentTarget).html(),this.affiche()}.bind(this))}function BlockFournitures(a){this.el=jQuery(a),jQuery("button.ValidFourniture").on("click",function(){this.majPrix(),navigation.PageOuvrage()}.bind(this))}function Ouvrages(a){this.listeComposants=new Array,this.calculs=new Object,this.libelle=a.libcom,this.libelletech=a.libelletech,this.unite=a.unite,this.id=a.id,this.code_ouvrage=a.code_ouvrage,jQuery.each(a.composants,function(a,b){this.addComposant(b)}.bind(this))}function Composants(a){this.R=new Object,this.R[1]=0,this.R[2]=0,this.R[3]=0,this.prixU=new Object,this.prixU[1]=0,this.prixU[2]=0,this.prixU[3]=0,this.prixInter=new Object,this.prixInter[1]=0,this.prixInter[2]=0,this.prixInter[3]=0,this.prixS=new Object,this.prixS[1]=0,this.prixS[2]=0,this.prixS[3]=0,this.prixRS=new Object,this.prixRS[1]=0,this.prixRS[2]=0,this.prixRS[3]=0,this.prixPV=new Object,this.prixPV[1]=0,this.prixPV[2]=0,this.prixPV[3]=0,this.prixModif=new Object,this.prixModif[1]=0,this.prixModif[2]=0,this.prixModif[3]=0,this.code=a.comp,this.libelle=a.libelle,this.type=a.type,this.unite=a.unite,this.cond=1*a.cond,this.hausrab=1*a.hausrab,this.R[1]=1*a.remise1,this.R[2]=1*a.remise2,this.R[3]=1*a.remise3,this.prixInter[1]=round2nbv(a.prix1),this.prixInter[2]=round2nbv(a.prix2),this.prixInter[3]=round2nbv(a.prix3),this.qte=a.quantite,this.serie=a.serie,this.isPrincipal()&&blockOuvrage.listeCompoPrincipaux.push(this)}function FamilleRecurs(a){this.lien=new Array,this.libelle=a.libelle,this.libtech=a.libtech,this.id=a.id,this.niveau=a.niveau}jQuery.postJSON=function(a,b){return jQuery.ajax({type:"POST",url:a,data:b,async:!1,dataType:"json"})},jQuery.getJSON=function(a,b,c){return jQuery.ajax(jQuery.extend({},{type:"GET",url:a,data:b,async:!0,dataType:"json"},c))},jQuery.deleteJSON=function(a,b){return jQuery.ajax({type:"DELETE",url:a,data:b,contentType:"text/json"})};var Api={domainUrl:"",scriptUrl:"",LoadOuvrages:{encours:0,ok:0,ko:0},dataCache:{listeFamille:{}},checkResponse:function(a,b){if(void 0!=typeof a.valid){if("undefined"!=typeof a.valid&&a.valid!==!0)throw new ApiException(a.message);var c=a.data;if("object"!=typeof c)throw new ApiException("les données attendues ne sont pas présentes");if(("undefined"==typeof b||!b)&&0==Object.keys(c).length)throw new ApiException("les données attendues doivent être présentes");return c}},GetFamilleAll:function(a){GenInfo.debug("Api.GetFamilleAll");var b=jQuery.Deferred();return void 0!=Api.dataCache.familleAll?b.resolve(Api.dataCache.familleAll):webSqlApi.execute(function(a){a.readTransaction(function(a){a.executeSql("SELECT value FROM familles ",void 0,function(a,c){if(0==c.rows.length||c.rows.length>1)return void b.reject({status:3,statusText:"Données erronnées."},"Données erronnées.");var d=JSON.parse(c.rows.item(0).value);Api.dataCache.familleAll=d,Api.genListeFamilles(d,!0),b.resolve(Api.dataCache.familleAll)},function(a){console.log(a),b.reject({status:2,statusText:"Erreur lors de la sélection des données."},"Erreur lors de la sélection des données.")})},function(){b.reject({status:1,statusText:"Erreur lors de la sélection des données."},"Erreur lors de la sélection des données.")})}),b},genListeFamilles:function(a,b){void 0!=b&&1==b&&(Api.dataCache.listeFamille.init={children:a}),jQuery.each(a,function(a,b){Api.dataCache.listeFamille[b.id]=b,void 0!=b.children&&Api.genListeFamilles(b.children)})},GetFamille:function(a){GenInfo.debug("Api.GetFamille");var b=jQuery.Deferred();return Api.LoadOuvrages.encours=0,Api.LoadOuvrages.ok=0,Api.LoadOuvrages.ko=0,Api.GetFamilleAll().done(function(c){var d="init";if(""!=a.parent&&(d=a.parent),void 0!=Api.dataCache.listeFamille[d]){var e=Api.dataCache.listeFamille[d];void 0!=e.children?b.resolve({valid:!0,data:e.children}):b.resolve({valid:!0,data:[]})}else b.reject({status:4,statusText:"Famille non trouvée"},"Famille non trouvée")}).fail(function(a,c){b.reject(a,c)}),b},allOuvragesLoaded:function(){var a=jQuery.Deferred();return Api.checkOuvragesDone(a),a},checkOuvragesDone:function(a){var b=Api.LoadOuvrages.encours,c=Api.LoadOuvrages.ok,d=Api.LoadOuvrages.ko;b>c+d?setTimeout(function(){Api.checkOuvragesDone(a)},1e3):a.resolve("Ouvrages  complet ok ")},GetOuvrage:function(a){GenInfo.debug("Api.GetOuvrage");var b=jQuery.Deferred();return Api.LoadOuvrages.encours++,webSqlApi.execute(function(c){c.readTransaction(function(c){c.executeSql("SELECT value FROM ouvrages WHERE id_parent=?",[parseInt(a.famille)],function(a,c){if(0==c.rows.length||c.rows.length>1)b.reject({status:5,statusText:"Données erronnées."},"Données erronnées."),Api.LoadOuvrages.ko++;else{var d={valid:!0,data:JSON.parse(c.rows.item(0).value)};b.resolve(d),Api.LoadOuvrages.ok++}},function(a){console.log(a),Api.LoadOuvrages.ko++,b.reject({status:6,statusText:"Erreur lors de la sélection des données."},"Erreur lors de la sélection des données.")})},function(){b.reject({status:7,statusText:"Erreur lors de la sélection des données."},"Erreur lors de la sélection des données."),Api.LoadOuvrages.ko++})}),b},GetDefaultParams:function(){console.log("Api.GetDefaultParams");var a=jQuery.Deferred();return webSqlApi.execute(function(b){b.readTransaction(function(b){b.executeSql("SELECT value FROM params WHERE name=?",["param"],function(b,c){if(0==c.rows.length||c.rows.length>1)return void a.reject({status:8,statusText:"Données erronnées."},"Données erronnées.");var d={valid:!0,data:JSON.parse(c.rows.item(0).value)};a.resolve(d)},function(b){console.log(b),Api.LoadOuvrages.ko++,a.reject({status:10,statusText:"Erreur lors de la sélection des données."},"Erreur lors de la sélection des données.")})},function(){a.reject({status:9,statusText:"Erreur lors de la sélection des données."},"Erreur lors de la sélection des données.")})}),a},GetFamilleRecursive:function(a){GenInfo.debug("Api.GetFamilleRecursive");var b=jQuery.Deferred();return Api.LoadOuvrages.encours=0,Api.LoadOuvrages.ok=0,Api.LoadOuvrages.ko=0,Api.GetFamilleAll().done(function(c){if(""==a.parent)return void b.reject({status:11,statusText:"Paramètre manquant."},"Paramètre manquant.");var d=a.parent;if(void 0!=Api.dataCache.listeFamille[d]){var e=Api.dataCache.listeFamille[d];b.resolve({valid:!0,data:[e]})}else b.reject({status:12,statusText:"Erreur lors de la sélection des données."},"Erreur lors de la sélection des données.")}),b},importFile:function(a){return GenInfo.debug("Api.importFile"),jQuery.getJSON(a,"",{async:!1})}},Projet={urlWs:"",urlScript:"",nomPrj:"Version mobile"},webSqlApi={flagsInit:null,dataBaseName:"chiffrage",dataBaseVersion:"1",dataBaseDesc:"Utilisée pour le chiffrage",dataBaseSize:10485760,checkInitDone:function(a){0==webSqlApi.flagsInit.initParam||0==webSqlApi.flagsInit.initOuvrage||0==webSqlApi.flagsInit.initFamille?setTimeout(function(){webSqlApi.checkInitDone(a)},1e3):a.resolve("Init complet ok ")},verifDatabase:function(){var a=jQuery.Deferred();db=openDatabase(webSqlApi.dataBaseName,"",webSqlApi.dataBaseDesc,webSqlApi.dataBaseSize);var b=function(){},c=!1,d=new Migrator(db);return d.setDebugLevel(Migrator.DEBUG_HIGH),d.migration(1,b),d.migration(2,b),d.migration(3,function(b){c=!0,webSqlApi.flagsInit={initParam:!1,initOuvrage:!1,initFamille:!1},webSqlApi.initParams(b).done(function(a){console.log(a),webSqlApi.flagsInit.initParam=!0}),webSqlApi.initOuvrages(b).done(function(a){console.log(a),webSqlApi.flagsInit.initOuvrage=!0}),webSqlApi.initFamilles(b).done(function(a){console.log(a),webSqlApi.flagsInit.initFamille=!0}),webSqlApi.checkInitDone(a)}),d.execute().whenDone(function(){0==c&&a.resolve("Pas de maj a faire : ok")}),a},deleteDatabase:function(){var a=openDatabase(webSqlApi.dataBaseName,"",webSqlApi.dataBaseDesc,webSqlApi.dataBaseSize);a.transaction(function(a){a.executeSql("DROP TABLE IF EXISTS params"),a.executeSql("DROP TABLE IF EXISTS familles"),a.executeSql("DROP TABLE IF EXISTS ouvrages"),a.executeSql("DROP TABLE IF EXISTS _migrator_schema")},function(a,b){}),GenInfo.success("Base de données SUPPRIME.")},initFamilles:function(a){var b=jQuery.Deferred();return a.executeSql("drop table if exists familles"),a.executeSql("CREATE TABLE IF NOT EXISTS familles (id_parent unique, value BLOB)"),Api.importFile("base/familles.json").done(function(c){var d;d=c[0].children;try{a.executeSql("INSERT INTO familles VALUES (?,?)",[c[0].id,JSON.stringify(d)],function(){b.resolve("Init famille OK")},function(){b.reject({status:"f1",statusText:"Erreur sur init des données."},"Erreur sur init des données.")})}catch(e){b.reject({status:"f2",statusText:"Erreur sur init des données."},"Erreur sur init des données.")}}).fail(function(a){b.reject({status:"f3",statusText:"Erreur sur init des données."},"Erreur sur init des données.")}),b},initOuvrages:function(a){var b=jQuery.Deferred();return a.executeSql("drop table if exists ouvrages"),a.executeSql("CREATE TABLE IF NOT EXISTS ouvrages (id_parent unique, value BLOB)"),Api.importFile("base/ouvrages.json").done(function(c){var d;d=c;var e=d.ouvrages.length,f=0;console.log("a faire : "+e);var g=function(){f++,console.log("Fait  : "+f+"a faire : "+e),f>=e&&b.resolve("init param ok")};jQuery.each(d.ouvrages,function(c,d){try{a.executeSql("INSERT INTO ouvrages VALUES (?,?)",[d.id,JSON.stringify(d.data)],function(){g(b)},function(){b.reject({status:"o1",statusText:"Erreur sur init des données."},"Erreur sur init des données.")})}catch(e){b.reject({status:"o2",statusText:"Erreur sur init des données."},"Erreur sur init des données.")}})}).fail(function(a){b.reject({status:"o3",statusText:"Erreur sur init des données."},"Erreur sur init des données.")}),b},initParams:function(a){var b=jQuery.Deferred();return a.executeSql("drop table if exists params"),a.executeSql("CREATE TABLE IF NOT EXISTS params (name unique, value BLOB)"),Api.importFile("base/params.json").done(function(c){var d;try{d=Api.checkResponse(c)}catch(e){if(e instanceof ApiException)return void GenInfo.error(e.toString());throw e}try{a.executeSql("INSERT INTO params VALUES (?,?)",["param",JSON.stringify(d)],function(){b.resolve("init param ok")},function(){b.reject({status:"p1",statusText:"Erreur sur init des données."},"Erreur sur init des données.")})}catch(f){b.reject({status:"p2",statusText:"Erreur sur init des données."},"Erreur sur init des données.")}}).fail(function(a){b.reject({status:"p3",statusText:"Erreur sur init des données."},"Erreur sur init des données.")}),b},execute:function(a){try{var b=openDatabase(webSqlApi.dataBaseName,"",webSqlApi.dataBaseDesc,webSqlApi.dataBaseSize);if("function"==typeof a)try{a(b)}catch(c){throw c}else GenInfo.debug("(execute) Erreur : le paramete n'est pas une fonction ")}catch(c){throw c}}};String.prototype.replaceAt=function(a,b){return this.substr(0,a)+b+this.substr(a+b.length)};var GenInfo={divInput:"genInfo",idTimeout:null,error:function(a,b){this.log(a,"danger"),"undefined"!=typeof b&&window.console&&console.log(b)},warning:function(a){this.log(a,"warning")},success:function(a){this.log(a,"success")},info:function(){this.log(message,"info")},log:function(a,b){"undefined"!=typeof jQuery("#"+this.divInput)&&jQuery("#"+this.divInput).length>0?(jQuery("#"+this.divInput).attr("class","alert alert-"+b),jQuery("#"+this.divInput+" .msg").html(a)):window.console&&console.log(b+" -----> ",a),setTimeout(function(){this.clear()}.bind(this),4e3)},clear:function(){jQuery("#"+this.divInput).attr("class","hide"),jQuery("#"+this.divInput+" .msg").html("")},debug:function(){window.console&&console.log(arguments)}},Configuration={urlWs:Projet.urlWs,urlScript:Projet.urlScript,init:function(){this.validator(),Api.domainUrl=this.urlWs,Api.scriptUrl=this.urlScript},validator:function(){jQuery.validator.addClassRules("price",{required:!0,number:!0}),jQuery.extend(jQuery.validator.messages,{required:"Une valeur est requise pour ce champ.",digits:"Ce nombre doit être un entier.",number:"Un nombre valide est requis"}),jQuery.validator.addMethod("dateMoisAnnee",function(a,b){var c=a.substring(0,2);return this.optional(b)||/^\d{2}\/\d{4}jQuery/.test(a)&&!isNaN(c)&&c>=1&&12>=c},"La date est invalide (format MM/AAAA)."),jQuery.validator.addMethod("dateAnnee",function(a,b){return this.optional(b)&&""==a||/^\d{4}jQuery/.test(a)},"L'ann&eacute;e est invalide (format AAAA).")}};Navigation.prototype={elWait:"",show:function(){return this.el.show(),this.wait().off(),this},hide:function(){return this.el.hide,this.wait().on(),this},wait:function(a){var b=this;return void 0!=a&&(this.elWait=a),console.log(this.elWait),{on:function(){void 0!=b.elWait&&""!=b.elWait&&jQuery(b.elWait).show()},off:function(){void 0!=b.elWait&&""!=b.elWait&&jQuery(b.elWait).hide()}}},closeAllBlock:function(){jQuery("div.containerBlock").hide()},PageOuvrage:function(){this.closeAllBlock(),blockOuvrage.show()},PageParametre:function(){this.closeAllBlock(),parametres.genFormParam(),parametres.show()},PageFourniture:function(){this.closeAllBlock(),blockFournitures.show()}},Parametres.prototype={paramsSaved:null,params:{listeParametres:{THM:{nom:"THM",titre:"Taux horaire Main oeuvre",valeurDef:{1:13.11,2:13.11,3:13.84},valeur:{1:13.11,2:13.11,3:13.84}},CSS:{nom:"CSS",titre:"Charges sur salaires",valeurDef:{1:100,2:100,3:105},valeur:{1:100,2:100,3:105},suffixe:"%"},CFGMO:{nom:"CFGMO",titre:"Coef FG sur MO",valeurDef:{1:1.57,2:1.57,3:1.66},valeur:{1:1.57,2:1.57,3:1.66}},CFGF:{nom:"CFGF",titre:"Coef FG fourniture",valeurDef:{1:1.05,2:1.05,3:1.05},valeur:{1:1.05,2:1.05,3:1.05}},CFGL:{nom:"CFGL",titre:"Coef FG location",valeurDef:{1:1.1,2:1.1,3:1.1},valeur:{1:1.1,2:1.1,3:1.1}},CFGS:{nom:"CFGS",titre:"Coef FG Sous Traitant",valeurDef:{1:1,2:1,3:1},valeur:{1:1,2:1,3:1}},MARGE:{nom:"MARGE",titre:"Marge",valeurDef:{1:10,2:10,3:7},valeur:{1:10,2:10,3:7},suffixe:"%"},THR:{nom:"THR",titre:"TH de revient",valeurDef:{1:0,2:0,3:0},valeur:{1:0,2:0,3:0},modifiable:!1},THV:{nom:"THV",titre:"TH de vente",valeurDef:{1:0,2:0,3:0},valeur:{1:0,2:0,3:0},modifiable:!1}},choixSerie:1,choixSerieName:"",maxProfondeur:4,ignoreNiveau:6,debug:!1},validateRules:{rules:{THM:{required:!0,number:!0},CSS:{required:!0,digits:!0},CFGMO:{required:!0,number:!0},CFGF:{required:!0,number:!0},CFGL:{required:!0,number:!0},CFGS:{required:!0,number:!0},MARGE:{required:!0,digits:!0,max:99}},messages:{MARGE:{required:!0,digits:!0,max:"Merci de rentrer une valeur inférieure ou égale à {0}"}}},init:function(){return this.getDefaultParams(),Mark.includes.debug=function(){return this.params.debug}.bind(this),this.params.debug?jQuery(".debug").show():jQuery(".debug").hide(),this.calculate(!0),this},calculate:function(a){var b=this.getParametres();if(1==a){for(var c=1;3>=c;c++)b.THR.valeurDef[c]=round2nbv(b.THM.valeurDef[c]*(2*b.CSS.valeurDef[c]/100)*b.CFGMO.valeurDef[c]);for(var c=1;3>=c;c++)b.THV.valeurDef[c]=round2nbv(b.THR.valeurDef[c]*(100/(100-b.MARGE.valeurDef[c])))}for(var c=1;3>=c;c++)b.THR.valeur[c]=round2nbv(b.THM.valeur[c]*(2*b.CSS.valeur[c]/100)*b.CFGMO.valeur[c]);for(var c=1;3>=c;c++)b.THV.valeur[c]=round2nbv(b.THR.valeur[c]*(100/(100-b.MARGE.valeur[c])))},show:function(){return this.genFormParam(),jQuery(".parametresform").validate(this.validateRules),this.saveParams(),this.el.show(),this},hide:function(){return this.el.hide(),this},saveParams:function(){this.paramsSaved=JSON.stringify(this.params.listeParametres)},restaureParams:function(){this.params.listeParametres=JSON.parse(this.paramsSaved),this.calculate(!0)},setParamValue:function(a,b,c,d){var e=this.getParametres();e[a]?"undefined"!=typeof d?e[a][b][d]=c:e[a][b]=c:this.error("setParamValue","Erreur le parametre "+a+"n'existe pas")},setParametresFromHtml:function(){return this.el.find(".parametresform").valid()?(this.el.find("input").each(function(a,b){this.setParamValue(jQuery(b).attr("name"),"valeur",jQuery(b).val(),this.getSerie())}.bind(this)),this.calculate(),!0):!1},getParametres:function(){return this.params.listeParametres},getDefaultParams:function(){Api.GetDefaultParams().done(function(a){var b;try{b=Api.checkResponse(a)}catch(c){if(GenInfo.debug(c),c instanceof ApiException)return void GenInfo.error(c.toString());throw c}jQuery.each(b.paramDefaut,function(a,b){var c=a;jQuery.each(b,function(a,b){"valeurDef"==a&&this.setParamValue(c,"valeur",b),this.setParamValue(c,a,b)}.bind(this))}.bind(this)),jQuery.each(b.general,function(a,b){this.params[a]=b}.bind(this)),this.calculate(!0)}.bind(this)).fail(function(a,b){GenInfo.debug(a,b),GenInfo.error("Erreur lors de l'appel au WS : "+a.status+" - "+a.statusText)})},genFormParam:function(){var a=this.getParametres(),b="",c=this.getSerie(),d=jQuery("select#choix-serie option:selected").html();this.el.find("span.nom-serie").html(d.toLowerCase()),jQuery.each(a,function(a,d){var e=jQuery("script.baParam").html();if(""===e)return void GenInfo.error("Erreur de g&eacute;n&eacute;ration","Template est vide");var f="";if("undefined"!=typeof d.suffixe)var f=d.suffixe;var g={titreParam:d.titre,nomParam:a,valeurParam:d.valeur[c],valeurParamDef:d.valeurDef[c]+" "+f};b+=Mark.up(e,g)}.bind(this)),this.el.find("form.parametresform").html(b),this.el.find("form.parametresform input").on("change",function(a){return jQuery("form.parametresform").valid()?(this.setParametresFromHtml(),void this.majTH()):!1}.bind(this))},majTH:function(){var a=this.getParametres(),b=a.THR.valeur[this.getSerie()],c=a.THV.valeur[this.getSerie()];jQuery("input#THR").val(""+b),jQuery("input#THV").val(""+c)},getSerie:function(){var a=this.params.choixSerie;return a},paramToString:function(){var a=this.getParametres(),b="",c=this.getSerie();return jQuery.each(a,function(a,d){""!=b&&(b+=", "),b+=d.titre+": "+d.valeur[c]}),b}},BlockOuvrage.prototype={listeDetailOuvrages:[],listeOuvrages:[],listeCompoPrincipaux:[],init:function(){this.listeCompoPrincipaux=new Array},show:function(){return this.affiche(),this.el.show(),jQuery("div.choixSerie").show(),this},hide:function(){return this.el.hide(),jQuery("div.choixSerie").hide(),this},getFamille:function(a,b){return void 0==a&&(a=""),void 0==b&&(b=""),a>=parametres.params.maxProfondeur?void this.getFamilleRecursive(b):void Api.GetFamille({parent:b}).done(function(c){var d;try{d=Api.checkResponse(c,!0)}catch(e){if(e instanceof ApiException)return void GenInfo.error(e.toString());throw e}if(0!==Object.keys(d).length)this.addSelectFamille(a,d);else{navigation.wait().on(),this.init();this.getOuvrage(b,this.listeOuvrages);Api.allOuvragesLoaded().done(function(){this.affiche()}.bind(this))}}.bind(this)).fail(function(a,b){GenInfo.debug(a,b),GenInfo.error("Erreur lors de l'appel aux données : "+a.status+" - "+a.statusText)})},addSelectFamille:function(a,b){if(""!=a){var c=jQuery("script.baSelFam").html();if(""===c)return void GenInfo.error("Erreur de g&eacute;n&eacute;ration de la famille","Template est vide");var d={selectName:"baFamille"+a,titreFamille:"Choix de la famille"};html=Mark.up(c,d),jQuery("div.list-select-fam").append(html)}var e=jQuery("#baFamille"+a);if(e.html(""),e.append('<option value="">Sélectionnez une valeur</option>'),jQuery.each(b,function(a,b){e.append('<option rel="'+b.libtech.replace(/\"/g,"&quot;")+'" value="'+b.id+'">'+b.libelle+"</option>")}),""!=a){var f=this;jQuery("#baFamille"+a).off("change").on("change",function(){var b=jQuery(this).val();return f.changeSelect(this),""==b?!1:void f.getFamille(1*a+1,b)})}},changeSelect:function(a){jQuery(a).parent().parent().nextAll().remove(),jQuery("tbody.resultat-ouvrage").html(""),jQuery("div.list-ouvrages").hide(),this.listeOuvrages=[]},getOuvrage:function(a,b){Api.GetOuvrage({famille:a}).done(function(a){var c;try{c=Api.checkResponse(a)}catch(d){if(d instanceof ApiException)return void GenInfo.error(d.toString());throw d}var e=[];void 0!=b&&(e=b),jQuery.each(c,function(a,b){var c=new Ouvrages(b);e.push(c)}.bind(this))}.bind(this)).fail(function(a,b){GenInfo.debug(a,b),GenInfo.error("Erreur lors de l'appel aux données : "+a.status+" - "+a.statusText)})},afficheDerLibelleFamille:function(){var a=jQuery(".list-select-fam").children(),b=a.last().find("select option:selected").attr("rel"),c=a.last().find("select option:selected").val(),d=jQuery("script.baNavFam").html();if(""===d)return void GenInfo.error("Erreur de g&eacute;n&eacute;ration","Template est vide");var e={"class":"nav-selected",libtech:b,libelle:"",colDeb:"",id:c},f=Mark.up(d,e);jQuery("tbody.resultat-ouvrage").append(f)},affiche:function(){return navigation.wait().on(),jQuery("div.list-ouvrages").hide(),0==this.listeOuvrages.length?void navigation.wait().off():(jQuery("tbody.resultat-ouvrage").html(""),this.listeDetailOuvrages=[],this.afficheFamEtOuvrage(this.listeOuvrages),parametres.params.debug?jQuery(".debug").show():jQuery(".debug").hide(),jQuery("td .ligne-fam").parent().addClass("noBorder noStripped"),jQuery('[data-toggle="tooltip"]').tooltip(),navigation.wait().off(),void jQuery("div.list-ouvrages").show())},getFamilleRecursive:function(a){navigation.wait().on(),Api.GetFamilleRecursive({parent:a}).done(function(a){var b;try{b=Api.checkResponse(a)}catch(c){if(c instanceof ApiException)return void GenInfo.error(c.toString());throw c}console.log("LR : ",b),this.init();var d=[];this.recursListeFamilleOuvrage(b,d),this.listeOuvrages=d,Api.allOuvragesLoaded().done(function(){this.affiche()}.bind(this))}.bind(this)).fail(function(a,b){GenInfo.debug(a,b),GenInfo.error("Erreur lors de la récupération des données : "+a.status+" - "+a.statusText)})},recursListeFamilleOuvrage:function(a,b){jQuery.each(a,function(a,c){var d=new FamilleRecurs(c);"undefined"!=typeof c.children?this.recursListeFamilleOuvrage(c.children,d.lien):this.getOuvrage(c.id,d.lien),b.push(d)}.bind(this))},afficheFamEtOuvrage:function(a){var b=parametres.getSerie();jQuery.each(a,function(a,c){if(c instanceof Ouvrages){var d="";this.listeDetailOuvrages.push(c),c.calculate();var e=jQuery("script.baLigneOuvrage").html();if(""===e)return void GenInfo.error("Erreur de g&eacute;n&eacute;ration","Template est vide");var f={code:c.code_ouvrage,libelle_tech:c.libelletech,libelle:c.calculs.libelle,nb_ouv:c.nb_ouv,unite:c.calculs.unite,mo:c.calculs.MO[b],ppale:c.calculs.ppale[b],secon:c.calculs.secon[b],total:c.calculs.total[b],prPoS:c.calculs.prPoS[b],prFoP:c.calculs.prFoP[b],pvPoS:c.calculs.pvPoS[b],pvFoP:c.calculs.pvFoP[b],backColor:a%2==0?"back-color":""};if(d+=Mark.up(e,f),parametres.params.debug){var g=jQuery("script.baTabCompo").html();if(""===e)return void GenInfo.error("Erreur de g&eacute;n&eacute;ration","Template est vide");var h={serie:b,listeCmp:c.listeComposants};d+=Mark.up(g,h)}jQuery("tbody.resultat-ouvrage").append(d)}else if(c instanceof FamilleRecurs){if(c.niveau!=parametres.params.ignoreNiveau&&""!=c.libelle){var e=jQuery("script.baNavFam").html();if(""===e)return void GenInfo.error("Erreur de g&eacute;n&eacute;ration","Template est vide");var f={"class":"nav-"+c.niveau,libelle:c.libelle,colDeb:c.niveau-5,id:c.id},i=Mark.up(e,f);jQuery("tbody.resultat-ouvrage").append(i)}this.afficheFamEtOuvrage(c.lien)}else GenInfo.error("Erreur de g&eacute;n&eacute;ration","Ni ouvrage, ni famille")}.bind(this)),jQuery("#navigation-page input.quantite-ouvrage").off().on("change",function(a){a.preventDefault();var b=jQuery(a.currentTarget),c=b.val();if(c.replace(",","."),!jQuery.isNumeric(c))return!1;var d=b.attr("rel");jQuery.each(this.listeDetailOuvrages,function(a,b){return b.code_ouvrage==d?(b.nb_ouv=c,!1):void 0}),this.affiche()}.bind(this))}},BlockFournitures.prototype={init:function(){},show:function(){return this.affPrixFournitures(),jQuery(".prixFournitureform").validate(),this.el.show(),this},hide:function(){return this.el.hide(),this},affPrixFournitures:function(){var a=parametres.getSerie(),b=[],c="";jQuery.each(blockOuvrage.listeCompoPrincipaux,function(d,e){if("undefined"==typeof b[e.code]){b[e.code]=1;var f=jQuery("script.baFourniture").html();if(""===f)return void GenInfo.error("Erreur de g&eacute;n&eacute;ration","Template est vide");var g=0,h=0;0!=e.prixModif[a]?(g=e.prixModif[a],h=e.prixInter[a]):g=h=e.prixInter[a];var i={titreParam:e.libelle,nomParam:e.code,unite:e.unite,valeurParam:g,valeurParamDef:h};c+=Mark.up(f,i)}}),this.el.find("form.prixFournitureform").html(c)},majPrix:function(){if(!this.el.find(".prixFournitureform").valid())return!1;var a=parametres.getSerie();this.el.find("input").each(function(b,c){jQuery.each(blockOuvrage.listeCompoPrincipaux,function(b,d){d.code==jQuery(c).attr("id")&&d.prixInter[a]!=jQuery(c).val()&&d.prixModif[a]!=jQuery(c).val()&&(d.prixModif[1]=d.prixModif[2]=d.prixModif[3]=jQuery(c).val())})}.bind(this))}},Ouvrages.prototype={libelle:"",libelletech:"",code_ouvrage:"",nb_ouv:1,unite:"",id:"",listeComposants:[],calculs:{},toString:function(){return"Ouvrage id = "+this.id+" - "+this.libelle},setOuvrages:function(a,b){this.nom=a,this.libelle=b},addComposant:function(a){var b=new Composants(a);this.listeComposants.push(b)},calculate:function(a){var b=parametres.getParametres();this.calculs.unite=this.unite,this.calculs.libelle=this.libelle,this.calculs.MO={1:0,2:0,3:0},this.calculs.ppale={1:0,2:0,3:0},this.calculs.secon={1:0,2:0,3:0},this.calculs.total={1:0,2:0,3:0},this.calculs.ppalePV={1:0,2:0,3:0},this.calculs.seconPV={1:0,2:0,3:0},this.calculs.totalPV={1:0,2:0,3:0},this.calculs.prPoS={1:0,2:0,3:0},this.calculs.prFoP={1:0,2:0,3:0},this.calculs.pvPoS={1:0,2:0,3:0},this.calculs.pvFoP={1:0,2:0,3:0},jQuery.each(this.listeComposants,function(a,c){c.calcul(),c.isMo()?(this.calculs.MO[c.serie]=c.qte,this.calculs.prPoS[c.serie]=round2nbv(b.THR.valeur[c.serie]*c.qte),this.calculs.pvPoS[c.serie]=round2nbv(b.THV.valeur[c.serie]*c.qte)):c.isPrincipal()?(this.calculs.ppale[1]=round2nbv(this.calculs.ppale[1]+c.prixRS[1]),this.calculs.ppale[2]=round2nbv(this.calculs.ppale[2]+c.prixRS[2]),this.calculs.ppale[3]=round2nbv(this.calculs.ppale[3]+c.prixRS[3]),this.calculs.ppalePV[1]=round2nbv(this.calculs.ppalePV[1]+c.prixPV[1]),this.calculs.ppalePV[2]=round2nbv(this.calculs.ppalePV[2]+c.prixPV[2]),this.calculs.ppalePV[3]=round2nbv(this.calculs.ppalePV[3]+c.prixPV[3])):(this.calculs.secon[1]=round2nbv(this.calculs.secon[1]+c.prixRS[1]),this.calculs.secon[2]=round2nbv(this.calculs.secon[2]+c.prixRS[2]),this.calculs.secon[3]=round2nbv(this.calculs.secon[3]+c.prixRS[3]),this.calculs.seconPV[1]=round2nbv(this.calculs.seconPV[1]+c.prixPV[1]),this.calculs.seconPV[2]=round2nbv(this.calculs.seconPV[2]+c.prixPV[2]),this.calculs.seconPV[3]=round2nbv(this.calculs.seconPV[3]+c.prixPV[3]))}.bind(this)),this.calculs.prPoS[1]=round2nbv(this.calculs.prPoS[1]*this.nb_ouv),this.calculs.prPoS[2]=round2nbv(this.calculs.prPoS[2]*this.nb_ouv),this.calculs.prPoS[3]=round2nbv(this.calculs.prPoS[3]*this.nb_ouv),this.calculs.pvPoS[1]=round2nbv(this.calculs.pvPoS[1]*this.nb_ouv),this.calculs.pvPoS[2]=round2nbv(this.calculs.pvPoS[2]*this.nb_ouv),this.calculs.pvPoS[3]=round2nbv(this.calculs.pvPoS[3]*this.nb_ouv),this.calculs.total[1]=round2nbv((this.calculs.ppale[1]+this.calculs.secon[1])*this.nb_ouv),this.calculs.total[2]=round2nbv((this.calculs.ppale[2]+this.calculs.secon[2])*this.nb_ouv),this.calculs.total[3]=round2nbv((this.calculs.ppale[3]+this.calculs.secon[3])*this.nb_ouv),this.calculs.totalPV[1]=round2nbv((this.calculs.ppalePV[1]+this.calculs.seconPV[1])*this.nb_ouv),this.calculs.totalPV[2]=round2nbv((this.calculs.ppalePV[2]+this.calculs.seconPV[2])*this.nb_ouv),this.calculs.totalPV[3]=round2nbv((this.calculs.ppalePV[3]+this.calculs.seconPV[3])*this.nb_ouv),this.calculs.prFoP[1]=round2nbv(this.calculs.total[1]+this.calculs.prPoS[1]),this.calculs.prFoP[2]=round2nbv(this.calculs.total[2]+this.calculs.prPoS[2]),this.calculs.prFoP[3]=round2nbv(this.calculs.total[3]+this.calculs.prPoS[3]),this.calculs.pvFoP[1]=round2nbv(this.calculs.totalPV[1]+this.calculs.pvPoS[1]),this.calculs.pvFoP[2]=round2nbv(this.calculs.totalPV[2]+this.calculs.pvPoS[2]),this.calculs.pvFoP[3]=round2nbv(this.calculs.totalPV[3]+this.calculs.pvPoS[3])}},Composants.prototype={code:"",libelle:"",type:0,unite:"",serie:"",cond:0,hausrab:0,prixU:{1:0,2:0,3:0},prixModif:{1:0,2:0,3:0},prixInter:{1:0,2:0,3:0},R:{1:0,2:0,3:0},prixS:{1:0,2:0,3:0},qte:0,prixRS:{1:0,2:0,3:0},prixPV:{1:0,2:0,3:0},isComposant:function(){return 1==this.type||5==this.type||2==this.type||3==this.type||4==this.type||7==this.type||8==this.type},isMo:function(){return 9==this.type||9==this.type},isPrincipal:function(){return 1==this.type},isSecondaire:function(){return 1==!this.type&&9==!this.type},calcul:function(){try{var a=parametres.getParametres();if(this.isComposant()){var b;switch(this.type){case 7:b=a.CFGL;break;case 8:b=a.CFGS;break;default:b=a.CFGF}for(var c=a.MARGE,d=1;3>=d;d++)0!=this.prixModif[d]?this.prixS[d]=round2nbv(this.prixModif[d]*b.valeur[d]):this.prixS[d]=round2nbv(this.prixInter[d]*b.valeur[d]);for(var d=1;3>=d;d++)this.prixRS[d]=round2nbv(this.prixS[d]*this.qte);for(var d=1;3>=d;d++)this.prixPV[d]=round2nbv(this.prixRS[d]*(100/(100-c.valeur[d])))}else this.prixRS[this.serie]=round2nbv(this.prixS[this.serie]*this.qte)}catch(e){GenInfo.error("Erreur de calcul des composants de l'ouvrage",e)}}},FamilleRecurs.prototype={libelle:"",libtech:"",id:0,niveau:0,lien:null,toString:function(){return"FamR id = "+this.id+" - "+this.libelle}};var navigation={},parametres={},blockOuvrage={},blockFournitures={};try{jQuery(function(){Configuration.init();try{GenInfo.debug("INIT : NAVIGATION"),navigation=new Navigation("#navigation-page").hide(),navigation.wait("div.signal-wait")}catch(a){GenInfo.error("Erreur initialisation application (NAV)",a)}webSqlApi.verifDatabase().done(function(a){try{GenInfo.debug("INIT : parametres"),parametres=new Parametres("div.parametres").init().hide()}catch(b){GenInfo.error("Erreur initialisation application (PAR)",b)}try{GenInfo.debug("INIT : ouvrages"),blockOuvrage=new BlockOuvrage("div.ouvrages").hide()}catch(b){GenInfo.error("Erreur initialisation application (OUV)",b)}try{GenInfo.debug("INIT : Fournitures"),blockFournitures=new BlockFournitures("div.fournitures").hide()}catch(b){GenInfo.error("Erreur initialisation application (FOU)",b)}navigation.show(),navigation.PageOuvrage()}).fail(function(a){console.log("Erreur retour verif DB : ",a),GenInfo.error("Erreur initialisation application (GEN)",a)})})}catch(err){alert(err)}